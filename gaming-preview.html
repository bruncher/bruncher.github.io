<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gaming Deals Preview</title>
<link rel="stylesheet" href="style.css" />
<link rel="icon" href="data:,">

<script type="module" crossorigin>
import React from "https://esm.sh/react@18.3.1";
import { createRoot } from "https://esm.sh/react-dom@18.3.1/client";

function GamingTable() {
  const [data, setData] = React.useState([]);
  const [loading, setLoading] = React.useState(true);

  // Pagination state
  const [pageSize, setPageSize] = React.useState(25);
  const [page, setPage] = React.useState(1);

  // SORTING STATE
  const [sortConfig, setSortConfig] = React.useState({
    key: null,
    direction: "asc",
  });
  
  // Sort handler
  const handleSort = (columnKey) => {
    setSortConfig((prev) => {
      if (prev.key === columnKey) {
        return {
          key: columnKey,
          direction: prev.direction === "asc" ? "desc" : "asc",
        };
      }
      return { key: columnKey, direction: "asc" };
    });
  };

  React.useEffect(() => {
    async function load() {
      try {
        const res = await fetch("https://gaming-api-4ic4.onrender.com/deals");
        const json = await res.json();
        setData(json.deals || []);
      } catch (e) {
        console.error("Error fetching deals:", e);
        setData([]);
      } finally {
        setLoading(false);
      }
    }
    load();
  }, []);

  // SORTED DATA
  const sortedData = React.useMemo(() => {
    if (!sortConfig.key) return data;
  
    return [...data].sort((a, b) => {
      const x = a[sortConfig.key];
      const y = b[sortConfig.key];
  
      if (x == null || y == null) return 0;
  
      // numeric string?
      const nx = Number(x);
      const ny = Number(y);
      
      if (!isNaN(nx) && !isNaN(ny)) {
        return sortConfig.direction === "asc" ? nx - ny : ny - nx;
      }
      
      // fallback to string compare
      return sortConfig.direction === "asc"
        ? String(x).localeCompare(String(y))
        : String(y).localeCompare(String(x));
  
    });
  }, [data, sortConfig]);
  
  // PAGINATION (after sorting)
  const totalPages = Math.ceil(sortedData.length / pageSize);
  const start = (page - 1) * pageSize;
  const visible = sortedData.slice(start, start + pageSize).map(item => {
    const scores = [
      Number(item.metacriticScore),
      Number(item.steamRatingPercent),
      Number(item.dealRating)
    ].filter(n => !isNaN(n));
  
    return {
      ...item,
      avgScore: scores.length ? scores.reduce((a, b) => a + b, 0) / scores.length : null
    };
  });

  // Reset to page 1 when page size changes
  React.useEffect(() => {
    setPage(1);
  }, [pageSize]);

  if (loading)
    return React.createElement("p", { style: { textAlign: "center" } }, "Loading…");

  if (!data.length)
    return React.createElement("p", { style: { textAlign: "center" } }, "No deals found.");

  return React.createElement(
    "div",
    null,

    // PAGE SIZE SELECTOR
    React.createElement(
      "div",
      { style: { marginBottom: "1rem", display: "flex", justifyContent: "flex-end", gap: "0.5rem" } },
      React.createElement("span", null, "Rows per page:"),
      React.createElement(
        "select",
        {
          value: pageSize,
          onChange: (e) => setPageSize(Number(e.target.value)),
        },
        [10, 25, 50, 100].map((n) =>
          React.createElement("option", { key: n, value: n }, n)
        )
      )
    ),

    // TABLE
    React.createElement(
      "div",
      { style: { overflowX: "auto", marginTop: "1rem" } },
      React.createElement(
        "table",
        { style: { width: "100%", borderCollapse: "collapse" } },
        React.createElement(
          "thead",
          null,
          React.createElement(
            "tr",
            null,
            React.createElement("th", null, "Thumb"),
            React.createElement("th", { onClick: () => handleSort("title"), style: { cursor: "pointer" } }, "Title"),
            React.createElement("th", { onClick: () => handleSort("storeName"), style: { cursor: "pointer" } }, "Store"),
            React.createElement("th", { onClick: () => handleSort("salePrice"), style: { cursor: "pointer" } }, "Price"),
            React.createElement("th", { onClick: () => handleSort("metacriticScore"), style: { cursor: "pointer" } }, "Metacritic"),
            React.createElement("th", { onClick: () => handleSort("steamRatingPercent"), style: { cursor: "pointer" } }, "Steam"),
            React.createElement("th", { onClick: () => handleSort("dealRating"), style: { cursor: "pointer" } }, "Deal"),
            React.createElement("th", { onClick: () => handleSort("avgScore"), style: { cursor: "pointer" } }, "Avg"),
          )
        ),
        React.createElement(
          "tbody",
          null,
          visible.map((item) =>
            React.createElement(
              "tr",
              { key: item.dealID },
            
              React.createElement(
                "td",
                null,
                React.createElement("img", {
                  src: item.thumb,
                  alt: item.title,
                  style: { height: "50px" },
                })
              ),
            
              React.createElement("td", null, item.title),
              React.createElement("td", null, item.storeName),
              React.createElement("td", null, `$${item.salePrice}`),
            
              // SCORE COLUMNS
              React.createElement("td", null, item.metacriticScore || "-"),
              React.createElement("td", null, item.steamRatingPercent || "-"),
              React.createElement("td", null, item.dealRating || "-"),
              React.createElement("td", null, item.avgScore != null ? item.avgScore.toFixed(1) : "-"), // stays "-" until you compute it
            )
          )
        )
      )
    ),

    // PAGINATION CONTROLS
    React.createElement(
      "div",
      {
        style: {
          marginTop: "1rem",
          display: "flex",
          justifyContent: "center",
          gap: "1rem",
        },
      },
      React.createElement(
        "button",
        {
          disabled: page === 1,
          onClick: () => setPage((p) => Math.max(1, p - 1)),
        },
        "Prev"
      ),
      React.createElement(
        "span",
        null,
        `Page ${page} of ${totalPages}`
      ),
      React.createElement(
        "button",
        {
          disabled: page === totalPages,
          onClick: () => setPage((p) => Math.min(totalPages, p + 1)),
        },
        "Next"
      )
    )
  );
}

window.addEventListener("DOMContentLoaded", () => {
  const root = createRoot(document.getElementById("app"));
  root.render(React.createElement(GamingTable));
});
</script>
</head>
<body>
<main style="max-width: 1100px; padding: 2rem 1rem; margin: 0 auto;">
  <h1 style="text-align:center; margin-bottom: 1rem;">Gaming Deals Preview</h1>
  <p style="text-align:center; color:#555;">This page is not linked publicly — safe to experiment.</p>

  <div class="dashboard-section">
    <h2 style="text-align:center; margin-bottom:1rem;">Gaming Deals</h2>
    <div id="app"></div>
  </div>
</main>
</body>
</html>
